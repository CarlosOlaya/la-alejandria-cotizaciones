<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizaci√≥n La Alejandr√≠a</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Open+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body style="visibility: hidden;">
    <script src="assets/js/navbar.js"></script>
    <script>
        document.body.style.visibility = 'visible';
        requestAnimationFrame(() => document.body.classList.add('page-loaded'));
    </script>

<div class="main-content">
<div class="container" id="quotation-container">
    <div class="header">
        <div class="logo-area">
            <img src="icon.png" alt="Logo La Alejandr√≠a">
            <div>
                <h1>La Alejandr√≠a</h1>
                <p>Caf√© Especial</p>
            </div>
        </div>
        <div class="company-data">
            <strong>NIT: 1104869101-4</strong>
            NO RESPONSABLE DE IVA<br>
            WhatsApp: 321 5039258
        </div>
    </div>

    <div class="doc-title">
        <h2>COTIZACI√ìN N¬∞ <span id="quotNumDisplay">____</span></h2>
        <div class="meta-data">
            <span><strong>Fecha de Expedici√≥n:</strong> <span id="dateExp">__/__/____</span></span>
            <span><strong>V√°lido hasta:</strong> <span id="dateValid">__/__/____</span></span>
        </div>
    </div>

    <div class="client-info">
        <input type="hidden" id="quotationNumber">
        <table>
            <tr>
                <td class="label">CLIENTE:</td>
                <td>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="clientName" class="autocomplete-input" placeholder="Escriba o seleccione cliente">
                        <div id="clientAutocompleteList" class="autocomplete-list"></div>
                    </div>
                </td>
                <td class="label">CC/NIT:</td>
                <td><input type="text" id="clientCCNIT" placeholder="CC o NIT"></td>
            </tr>
            <tr>
                <td class="label">DIRECCI√ìN:</td>
                <td colspan="3"><input type="text" id="clientAddress" placeholder="Direcci√≥n"></td>
            </tr>
            <tr>
                <td class="label">TEL√âFONO:</td>
                <td><input type="text" id="clientPhone" placeholder="Tel√©fono"></td>
                <td class="label">EMAIL:</td>
                <td><input type="text" id="clientEmail" placeholder="Email"></td>
            </tr>
        </table>
    </div>

    <div class="items-table-wrapper">
        <table class="items-table">
            <thead>
                <tr>
                    <th width="10%" class="text-center">CANT.</th>
                    <th width="38%">DESCRIPCI√ìN / ART√çCULOS</th>
                    <th width="14%" class="text-right">VR. UNIT.</th>
                    <th width="14%" class="text-right">DESC. UNIT.</th>
                    <th width="14%" class="text-right">TOTAL</th>
                    <th width="10%" class="text-center">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="itemsTableBody">
            </tbody>
        </table>
    </div>
    <button class="btn btn-primary btn-add-item" onclick="addItemRow()">+ Agregar Producto</button>

    <div class="totals">
        <table>
            <tr>
                <td class="text-right"><strong>SUBTOTAL:</strong></td>
                <td class="text-right"><input type="text" id="subtotal" value="$ 0" readonly></td>
            </tr>
            <tr>
                <td class="text-right"><strong>DESCUENTO:</strong></td>
                <td class="text-right"><input type="text" id="discount" value="$ 0" readonly></td>
            </tr>
            <tr class="total-final">
                <td class="text-right">TOTAL:</td>
                <td class="text-right"><input type="text" id="total" value="$ 0" readonly></td>
            </tr>
        </table>
    </div>

    <div class="footer">
        <p><strong>T√©rminos y Condiciones:</strong></p>
        <p class="terms">
            1. Esta cotizaci√≥n es v√°lida por 15 d√≠as calendario a partir de la fecha de expedici√≥n.<br>
            2. Tiempos de entrega sujetos a disponibilidad. Despacho tras confirmaci√≥n de pago.<br>
            3. Para confirmar su pedido, env√≠e el soporte de pago al WhatsApp 321 5039258.
        </p>
    </div>

    <div class="actions-footer">
        <button class="btn btn-success btn-save" onclick="saveQuotation()">üíæ Guardar</button>
        <button class="btn btn-primary btn-print" onclick="printQuotation()">üñ®Ô∏è Imprimir</button>
    </div>
    </div>
</div>
</div>

<script src="assets/js/app.js"></script>
<script>
    // Funci√≥n para generar el nombre del PDF
    function generatePDFName() {
        const clientName = document.getElementById('clientName').value.trim() || 'Cotizacion';
        const dateExpInput = document.getElementById('dateExp').textContent;
        
        // Convertir la fecha de formato dd/mm/yyyy a dd_mm_yy
        let fileName = clientName.toUpperCase().replace(/\s+/g, '_');
        
        if (dateExpInput && dateExpInput !== '__/__/____') {
            const [day, month, year] = dateExpInput.split('/');
            const shortYear = year.slice(-2);
            fileName += `_${day}_${month}_${shortYear}`;
        }
        
        return fileName;
    }
    
    // Funci√≥n para imprimir con nombre de archivo personalizado
    function printQuotation() {
        const pdfName = generatePDFName();
        document.title = pdfName;
        window.print();
        // Restaurar t√≠tulo original despu√©s de un peque√±o delay
        setTimeout(() => {
            document.title = 'Cotizaci√≥n La Alejandr√≠a';
        }, 500);
    }

    // Inicializar p√°gina de cotizaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const quotationId = urlParams.get('id');
        const shouldPrint = urlParams.get('print') === 'true';
        
        // Esperar a que quotationSystem est√© completamente inicializado
        if (quotationId) {
            // Cargar desde API
            quotationSystem.loadQuotation(parseInt(quotationId));
            
            // Calcular totales despu√©s de cargar
            setTimeout(() => {
                calculateTotals();
                
                // Si hay par√°metro print, ejecutar impresi√≥n autom√°tica
                if (shouldPrint) {
                    setTimeout(() => {
                        const pdfName = generatePDFName();
                        document.title = pdfName;
                        window.print();
                        setTimeout(() => {
                            document.title = 'Cotizaci√≥n La Alejandr√≠a';
                        }, 500);
                    }, 300);
                }
            }, 100);
        } else {
            generateNewQuotation();
        }
    });
</script>

<script src="assets/js/autocomplete.js"></script>
<script>
    // Inicializar autocomplete de clientes
    const clientAutocomplete = new AutocompleteManager(
        '#clientName',
        '#clientAutocompleteList',
        '/api/clients',
        (clientData) => {
            document.getElementById('clientCCNIT').value = clientData.cc_nit || '';
            document.getElementById('clientAddress').value = clientData.address || '';
            document.getElementById('clientPhone').value = clientData.phone || '';
            document.getElementById('clientEmail').value = clientData.email || '';
        }
    );
</script>

<script src="assets/js/ui.js"></script>
<script>
    // Inicializar UI (hamburger, sidebar, buttons)
    document.addEventListener('DOMContentLoaded', () => {
        initUI();
    });
    
    // Redefine button handlers for cotization page
    function initHeaderButtons() {
        const dashboardBtn = document.getElementById('dashboard-btn');
        const productsBtn = document.getElementById('products-btn');
        
        if (dashboardBtn) {
            dashboardBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }
        
        if (productsBtn) {
            productsBtn.addEventListener('click', () => {
                window.location.href = 'productos.html';
            });
        }
    }
    
    // Override the ui.js initUI to include header buttons init
    const originalInitUI = initUI;
    initUI = function() {
        originalInitUI();
        initHeaderButtons();
        loadQuotationsToSidebar();
        initSidebarSearch();
    };
</script>
</body>
</html>
